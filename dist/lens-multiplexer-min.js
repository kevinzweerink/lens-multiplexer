function Editor(e){this.editor=d3.select(".editor"),this.model=e,this.listen(),this.selectTab("lenses"),this.render()}function Lens(e,t){this.poles=[],this.name=e,t&&t.length>0&&(this.poles=t.map(function(e){return e}))}function Material(e,t){this.name=e,this.lenses=t}function Model(){this.lenses=[],this.material=[]}window.onload=function(){window.model=window.model||new Model,window.editor=window.editor||new Editor(model),window.model["import"](window.data),window.editor.render(),window.vis.init(),window.model.addToUpdateQueue(window.vis.update.bind(window.vis))},Editor.prototype.gatherTemplates=function(){var e={};d3.selectAll(".template").each(function(t){e[this.dataset.templateName]=this.cloneNode(!0),e[this.dataset.templateName].classList.remove("template")}).remove();this.templates=e},Editor.prototype.selectTab=function(e){d3.selectAll(".editor .toggle").classed("selected",!1),d3.select(".editor .toggle."+e).classed("selected",!0),d3.selectAll(".editor .view").classed("hidden",function(){return!this.classList.contains(e)})},Editor.prototype.renderMaterialTab=function(){var e=this.editor.select(".material.view"),t=this;e.selectAll(".material-node").remove();var n=e.selectAll(".material-node").data(this.model.material).enter().append("li").classed("material-node",!0);n.append("h1").text(function(e){return e.name}).on("click",function(){this.parentNode.classList.toggle("expanded")}),n.append("button").classed("delete",!0).html("&times;").on("click",function(e){t.model.removeMaterial(e.name),t.render()});var s=n.append("ul").classed("lenses",!0),o=s.selectAll(".lens").data(function(e){return e.lenses}).enter().append("li").classed("lens",!0).text(function(e){return e.name}),a=o.append("ul").classed("poles",!0),i=a.selectAll(".pole").data(function(e){return e.poles}).enter().append("li").classed("pole",!0).text(function(e){return e.name});i.append("input").attr("type","range").attr("min",0).attr("max",10).attr("value",function(e){return e.value}).on("change",function(e){var n=d3.select(this.parentNode.parentNode.parentNode.parentNode).datum().name;t.model.setPoleValue(e.value,e.name,e.lens,n)})},Editor.prototype.renderSchemaTab=function(){var e=this.editor.select(".lenses.view"),t=this;e.selectAll(".lens").remove();var n=e.selectAll(".lens").data(this.model.lenses).enter().append("li").classed("lens",!0);n.append("h1").text(function(e){return e.name}),n.append("button").classed("delete",!0).html("&times;").on("click",function(e){t.model.removeLens(e.name),t.render()});var s=n.append("ul").classed("poles",!0);s.selectAll(".pole").data(function(e){return e.poles}).enter().append("li").classed("pole",!0).text(function(e){return e}).append("button").classed("delete",!0).html("&times;").on("click",function(e){var n=d3.select(this.parentNode.parentNode).datum().name;t.model.removePoleFromLens(n,e),t.render()});s.append("input").attr("class","create-pole").attr("placeholder","Add pole").attr("type","text").on("keyup",function(e){13===d3.event.keyCode&&(t.model.addPoleToLens(e.name,this.value),t.render())})},Editor.prototype.render=function(){this.renderSchemaTab(),this.renderMaterialTab()},Editor.prototype.createLens=function(e){this.model.addLens(e),this.render()},Editor.prototype.createMaterial=function(e){this.model.addMaterial(e),this.render()},Editor.prototype.listen=function(){var e=this;this.editor.selectAll(".toggle").on("click",function(){e.selectTab(this.dataset.tab)}),this.editor.select(".create-lens").on("keyup",function(){13===d3.event.keyCode&&(e.createLens(this.value),this.value="")}),this.editor.select(".create-material").on("keyup",function(){13===d3.event.keyCode&&(e.createMaterial(this.value),this.value="")})},Lens.prototype.addPole=function(e){this.poles.push(e)},Lens.prototype.removePole=function(e){var t=this.poles.indexOf(e);this.poles.splice(t,1)},Material.prototype.getLens=function(e){return this.lenses.reduce(function(t,n){return n.name===e?n:t},void 0)},Material.prototype.addLens=function(e){this.lenses.push(e)},Material.prototype.getPole=function(e,t){return"string"==typeof e&&(e=this.getLens(e)),e.poles.reduce(function(e,n){return n.name===t?n:e},void 0)},Material.prototype.setValueForPole=function(e,t,n){var s=this.getLens(t),o=this.getPole(s,n);o&&(o.value=e)},Material.prototype.extendWithSchema=function(e){for(var t=this,n=0;n<e.length;++n){var s=e[n],o=this.getLens(s.name);o&&(s.poles=s.poles.map(function(e){var n=t.getPole(o,e.name);return n&&(e.value=n.value),e}))}this.lenses=e},Model.prototype["import"]=function(e){_this=this,this.lenses=e.lenses.map(function(e){return new Lens(e.name,e.poles)}),this.material=e.material.map(function(e){for(var t=_this.generateEmptyLensSchema(),n=new Material(e.name,t),s=0;s<e.lenses.length;++s){var o=e.lenses[s];for(var a in o.poles){var i=o.poles[a];n.setValueForPole(i,o.name,a)}}return n})},Model.prototype.addToUpdateQueue=function(e){this.updateQueue||(this.updateQueue=[]),this.updateQueue.push(e)},Model.prototype.updated=function(){this.updateQueue.forEach(function(e){e()})},Model.prototype.getLens=function(e){return this.lenses.reduce(function(t,n,s){return n.name===e?n:t},void 0)},Model.prototype.getLensPosition=function(e){return this.lenses.reduce(function(t,n,s){return n.name===e?s:t},void 0)},Model.prototype.getMaterial=function(e){return this.material.reduce(function(t,n){return(n.name=e)?n:t},void 0)},Model.prototype.getMaterialPosition=function(e){return this.material.reduce(function(t,n,s){return n.name===e?s:t},void 0)},Model.prototype.addLens=function(e,t){var n=new Lens(e,t,this);this.lenses.push(n),this.propagateSchema(),this.updated()},Model.prototype.addPoleToLens=function(e,t){if("string"==typeof e){var n=this.getLens(e);n&&(n.addPole(t),this.propagateSchema(),this.updated())}else console.log("Could not add pole, please provide pole as string")},Model.prototype.removeLens=function(e){var t=this.getLensPosition(e);this.lenses.splice(t,1),this.propagateSchema(),this.updated()},Model.prototype.removePoleFromLens=function(e,t){var e=this.getLens(e);e.removePole(t),this.propagateSchema(),this.updated()},Model.prototype.addMaterial=function(e){var t=new Material(e,this.generateEmptyLensSchema());this.material.push(t),this.updated()},Model.prototype.removeMaterial=function(e){var t=this.getMaterialPosition(e);void 0!==t&&(this.material.splice(t,1),this.updated())},Model.prototype.setPoleValue=function(e,t,n,s){var o=this.getMaterial(s);if(!o)return!1;var a=o.getPole(n,t);return a?(a.value=e,void this.updated()):!1},Model.prototype.generateEmptyLensSchema=function(){var e=this.lenses.map(function(e){return{name:e.name,poles:e.poles.map(function(t,n){return{name:t,index:n,value:0,lens:e.name}})}});return e},Model.prototype.propagateSchema=function(){for(var e=0;e<this.material.length;++e){var t=this.material[e],n=this.generateEmptyLensSchema();t.extendWithSchema(n)}},window.data={material:[{name:"Top News",lenses:[{name:"Active/Passive Usage",poles:{active:0,passive:10}},{name:"Me/NYT",poles:{me:0,nyt:10}},{name:"Reader/User/Customer",poles:{reader:10,user:0,customer:0}},{name:"Moments",poles:{prepare_me:10,update_me:7,entertain_me:4,connect_me:6,follow_developing:7,follow_planned:3,improve_me:2}}]},{name:"Collections",lenses:[{name:"Active/Passive Usage",poles:{active:2,passive:8}},{name:"Me/NYT",poles:{me:1,nyt:9}},{name:"Reader/User/Customer",poles:{reader:10,user:0,customer:0}},{name:"Moments",poles:{prepare_me:3,update_me:3,entertain_me:8,connect_me:5,follow_developing:5,follow_planned:5,improve_me:3}}]},{name:"Article",lenses:[{name:"Active/Passive Usage",poles:{active:4,passive:6}},{name:"Me/NYT",poles:{me:0,nyt:10}},{name:"Reader/User/Customer",poles:{reader:10,user:0,customer:0}},{name:"Moments",poles:{prepare_me:6,update_me:8,entertain_me:8,connect_me:3,follow_developing:5,follow_planned:5,improve_me:7}}]},{name:"Recommended",lenses:[{name:"Active/Passive Usage",poles:{active:3,passive:7}},{name:"Me/NYT",poles:{me:6,nyt:4}},{name:"Reader/User/Customer",poles:{reader:8,user:2,customer:0}},{name:"Moments",poles:{prepare_me:0,update_me:0,entertain_me:10,connect_me:6,follow_developing:0,follow_planned:0,improve_me:0}}]},{name:"Trending",lenses:[{name:"Active/Passive Usage",poles:{active:0,passive:10}},{name:"Me/NYT",poles:{me:0,nyt:4}},{name:"Reader/User/Customer",poles:{reader:10,user:2,customer:0}},{name:"Moments",poles:{prepare_me:0,update_me:0,entertain_me:10,connect_me:10,follow_developing:6,follow_planned:6,improve_me:0}}]},{name:"Saved",lenses:[{name:"Active/Passive Usage",poles:{active:8,passive:2}},{name:"Me/NYT",poles:{me:8,nyt:2}},{name:"Reader/User/Customer",poles:{reader:7,user:3,customer:0}},{name:"Moments",poles:{prepare_me:0,update_me:0,entertain_me:10,connect_me:10,follow_developing:0,follow_planned:0,improve_me:6}}]},{name:"Following",lenses:[{name:"Active/Passive Usage",poles:{active:6,passive:4}},{name:"Me/NYT",poles:{me:5,nyt:5}},{name:"Reader/User/Customer",poles:{reader:6,user:4,customer:0}},{name:"Moments",poles:{prepare_me:8,update_me:8,entertain_me:10,connect_me:6,follow_developing:8,follow_planned:8,improve_me:4}}]},{name:"Notifications",lenses:[{name:"Active/Passive Usage",poles:{active:3,passive:7}},{name:"Me/NYT",poles:{me:0,nyt:10}},{name:"Reader/User/Customer",poles:{reader:5,user:5,customer:0}},{name:"Moments",poles:{prepare_me:8,update_me:8,entertain_me:2,connect_me:5,follow_developing:5,follow_planned:5,improve_me:0}}]},{name:"Search",lenses:[{name:"Active/Passive Usage",poles:{active:10,passive:0}},{name:"Me/NYT",poles:{me:5,nyt:5}},{name:"Reader/User/Customer",poles:{reader:5,user:5,customer:0}},{name:"Moments",poles:{prepare_me:8,update_me:8,entertain_me:0,connect_me:0,follow_developing:8,follow_planned:8,improve_me:6}}]},{name:"Profile",lenses:[{name:"Active/Passive Usage",poles:{active:10,passive:0}},{name:"Me/NYT",poles:{me:8,nyt:2}},{name:"Reader/User/Customer",poles:{reader:0,user:10,customer:5}},{name:"Moments",poles:{prepare_me:0,update_me:0,entertain_me:0,connect_me:0,follow_developing:0,follow_planned:0,improve_me:0}}]},{name:"Subscriptions",lenses:[{name:"Active/Passive Usage",poles:{active:10,passive:0}},{name:"Me/NYT",poles:{me:7,nyt:3}},{name:"Reader/User/Customer",poles:{reader:2,user:5,customer:10}},{name:"Moments",poles:{prepare_me:0,update_me:0,entertain_me:0,connect_me:0,follow_developing:0,follow_planned:0,improve_me:0}}]},{name:"Billing Information",lenses:[{name:"Active/Passive Usage",poles:{active:10,passive:0}},{name:"Me/NYT",poles:{me:10,nyt:0}},{name:"Reader/User/Customer",poles:{reader:0,user:0,customer:10}},{name:"Moments",poles:{prepare_me:0,update_me:0,entertain_me:0,connect_me:0,follow_developing:0,follow_planned:0,improve_me:0}}]}],lenses:[{name:"Active/Passive Usage",poles:["active","passive"]},{name:"Me/NYT",poles:["me","nyt"]},{name:"Reader/User/Customer",poles:["reader","user","customer"]},{name:"Moments",poles:["prepare_me","update_me","entertain_me","connect_me","follow_developing","follow_planned","improve_me"]}]};var TAU=2*Math.PI;window.vis={init:function(){this.width=window.innerWidth-document.querySelector(".editor").offsetWidth,this.height=window.innerHeight,this.smallestDimension=this.height<this.width?this.height:this.width,this.cx=this.width/2,this.cy=this.height/2,this.data=window.model,this.svg=d3.select("body").append("svg").attr("width",this.width).attr("height",this.height),this.force=d3.layout.force().charge(-500).size([this.width,this.height]).nodes(this.data.material).gravity(.01).start(),this.drag=d3.behavior.drag(),this.drawConnectors(),this.drawSchemas(),this.drawNodes(),this.listen()},pointForAngleAndRadius:function(e,t){return{x:Math.cos(e)*t+this.cx,y:Math.sin(e)*t+this.cy}},processConnectionData:function(e){for(var t=[],n=0;n<e.length;++n)for(var s=e[n],o=0;o<s.lenses.length;++o)for(var a=s.lenses[o],i=0;i<a.poles.length;++i){var r=a.poles[i];t.push({node:n,mass:"#schema-"+r.name,value:r.value})}return t},drawConnectors:function(){this.connector=this.svg.selectAll(".connector").data(this.processConnectionData(this.data.material)),this.connector.enter().append("line").classed("connector",!0).style("stroke-width",.5).style("stroke","#FFF").style("opacity",0),this.connector.exit().remove()},drawSchemas:function(){var e=this;this.schema=this.svg.selectAll(".schema").data(this.data.lenses),this.schema.enter().append("g").classed("schema",!0),this.schema.exit().remove(),this.schemaGuide=this.schema.selectAll(".radius").data(function(e){return e}),this.schemaGuide.enter().append("circle").classed("radius",!0).attr("r",function(t,n){return e.smallestDimension/3+20*n}).attr("cx",this.cx).attr("cy",this.cy).style("stroke","#FFF").style("fill","rgba(0,0,0,0)").style("pointer-events","none"),this.schemaGuide.exit().remove(),this.mass=this.schema.selectAll(".mass").data(function(t,n){return t.poles.map(function(s,o){var a=TAU*o/t.poles.length,i=e.smallestDimension/3+20*n,r=e.pointForAngleAndRadius(a,i);return{pole:s,r:i,position:r,index:o,total:t.poles.length,angle:a}})}),this.mass.enter().append("circle").classed("mass",!0).attr("id",function(e){return"schema-"+e.pole}).attr("r",4).style("stroke","#666").style("fill","#000").attr("cx",function(e){return e.position.x}).attr("cy",function(e){return e.position.y}),this.mass.exit().remove(),this.massLabel=this.schema.selectAll(".mass-label").data(function(t,n){return t.poles.map(function(s,o){var a=TAU*o/t.poles.length,i=e.smallestDimension/3+20*n,r=e.pointForAngleAndRadius(a,i);return{pole:s,r:i,position:r,index:o,total:t.poles.length,angle:a}})}),this.massLabel.enter().append("text").classed("mass-label",!0).attr("x",function(e){return e.position.x+5}).attr("y",function(e){return e.position.y-5}).attr("fill","#FFF").text(function(e){return e.pole.split("_").join(" ")}),this.massLabel.exit().remove()},drawNodes:function(){this.node=this.svg.selectAll(".node").data(this.data.material),this.node.enter().append("circle").attr("class","node").attr("r",3).style("fill","#FFF"),this.node.exit().remove(),this.nodeLabel=this.svg.selectAll(".node-label").data(this.data.material),this.nodeLabel.enter().append("text").attr("class","node-label").attr("fill","#FFF").text(function(e){return e.name}),this.nodeLabel.exit().remove()},resolvePosition:function(e){var t=e.attr("cx")-this.cx,n=e.attr("cy")-this.cy,s=Math.sqrt(t*t+n*n),o=e.datum(),a=Math.atan2(n,t),i=TAU*o.index/o.total,r=a-i,l=this,d=d3.select(e.node().parentNode);d.select(".radius").attr("r",s),d.selectAll(".mass").filter(function(t){return this===e.node()?null:this}).attr("cx",function(e){return l.pointForAngleAndRadius(e.angle+r,s).x}).attr("cy",function(e){return l.pointForAngleAndRadius(e.angle+r,s).y}),d.selectAll(".mass-label").attr("x",function(e){return l.pointForAngleAndRadius(e.angle+r,s).x+5}).attr("y",function(e){return l.pointForAngleAndRadius(e.angle+r,s).y-5})},resolveGravity:function(e,t){for(var t=0;t<e.lenses.length;++t){var n=e.lenses[t];if(0!==n.poles.length){var s=n.poles.reduce(function(e,t){return e+t.value},0);if(0!==s)for(var o=0;o<n.poles.length;++o){var a=n.poles[o];if(d3.select("#schema-"+a.name).node().parentNode.classList.contains("focused")){var i=a.value;i=i/s*10,i=10===i?.1:.1/(10-i);var r=this.svg.select("#schema-"+a.name),l=parseInt(r.attr("cx"))-e.x,d=parseInt(r.attr("cy"))-e.y;e.x+=l*i,e.y+=d*i}}}}},revealConnectorsForNode:function(e){var t=this,n=function(){var n=0;return t.node.filter(function(t,s){this===e.node()&&(n=s)}),n}();this.connector.filter(function(e){return e.node===n}).style("opacity",function(e){return e.value/10})},hideAllConnectors:function(){this.connector.style("opacity",0)},selectRing:function(e){this.schema.classed("focused",!1),this.schema.filter(function(t,n){return n===e}).classed("focused",!0),0===d3.selectAll(".focused").size()&&this.schema.classed("focused",!0),this.selectedRing=e},listenForDragBehaviors:function(){var e,t=this;this.drag.on("dragstart",function(){e=d3.select(d3.event.sourceEvent.target),e.node().parentNode.classList.add("dragging")}),this.drag.on("drag",function(){e.attr("cx",d3.event.x).attr("cy",d3.event.y),t.resolvePosition(e),t.force.resume()}),this.drag.on("dragend",function(){e.node().parentNode.classList.remove("dragging")})},frame:function(){var e=this;this.node.each(this.resolveGravity.bind(this)).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}),this.nodeLabel.attr("x",function(e){return e.x+5}).attr("y",function(e){return e.y-5}),this.connector.attr("x1",function(t){return e.node.filter(function(e,n){return n===t.node}).attr("cx")}).attr("y1",function(t){return e.node.filter(function(e,n){return n===t.node}).attr("cy")}).attr("x2",function(e){return d3.select(e.mass).attr("cx")}).attr("y2",function(e){return d3.select(e.mass).attr("cy")})},listenForNodeActions:function(){var e=this;this.node.on("mouseenter",function(){e.revealConnectorsForNode(d3.select(this)),e.force.resume()}),this.node.on("mouseleave",function(){e.hideAllConnectors(),e.force.resume()})},listenForRingSelection:function(){var e=this;this.selectedRing=this.schema.size(),window.addEventListener("keyup",function(t){32===t.keyCode&&(t.preventDefault(),e.selectedRing++,e.selectedRing>e.schema.size()&&(e.selectedRing=0),e.selectRing(e.selectedRing)),e.force.resume()}),this.selectRing(this.selectedRing)},update:function(){this.force.start(),this.drawConnectors(),this.drawSchemas(),this.drawNodes()},listen:function(){this.mass.call(this.drag),this.listenForDragBehaviors(),this.listenForNodeActions(),this.listenForRingSelection(),this.force.on("tick",this.frame.bind(this))}};